<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>–ì–∏—Ä–ª—è–Ω–¥–∞</title>
    <base href="page">
    <link rel="stylesheet" href="css/milligram.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script>
        let wifiConf;
        let ledConf;

        function saveConfig() {
            fetch("/conf/wifi.json", {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(wifiConf)
            });
        }

        function initUpdForms() {
            let log = document.getElementById('log');
            let codefs = document.getElementById('code_fs');
            initUpdForm(codefs, '/upd/code', log, "–∫–æ–¥")
            let fsfs = document.getElementById('fs_fs');
            initUpdForm(fsfs, '/upd/files', log, "—Ñ–∞–π–ª—ã")
        }

        function initUpdForm(elem, path, log, name) {
            let input = elem.getElementsByTagName("input").item(0);
            let button = elem.getElementsByTagName("button").item(0);
            button.addEventListener('click', () => {
                const fd = new FormData();
                fd.append('file', input.files[0]);
                addLog("–ó–∞–≥—Ä—É–∂–∞–µ–º " + name + " —Ñ–∞–π–ª " + input.files[0].name, log)
                fetch(path, {
                    method: 'POST',
                    body: fd
                })
                    .then(res => {
                        if (res.ok) {
                            addLog("–£—Å–ø–µ—Ö !", log)
                            res.json();
                        } else {
                            onError(res, log)
                        }
                    })
                    .catch(err => onError(err, log));

            });
        }

        function addLog(text, log) {
            let logFragment = document.createElement("div");
            logFragment.innerHTML = text;
            log.appendChild(logFragment)
        }

        function onError(err, log) {
            if (err instanceof Response) {
                addLog("–û—à–∏–±–∫–∞ ! " + err.status, log);
                console.log(err);
            } else {
                addLog("–û—à–∏–±–∫–∞ ! " + err, log);
                console.log(err)
            }

        }


        function changeTab(tabName) {
            let i, tabcontent;
            tabcontent = document.getElementsByClassName("container");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            document.getElementById(tabName).style.display = "block";
            updateInfo(tabName);
        }

        function createConnectionDom(ssid, pass) {
            let tr = document.createElement('tr');

            let ssidTd = document.createElement('td');
            ssidTd.classList.add("ssid");
            ssidTd.innerHTML = ssid;
            tr.appendChild(ssidTd);

            let passTd = document.createElement('td');
            passTd.classList.add("password");
            passTd.innerHTML = pass;
            tr.appendChild(passTd);

            let buttonTd = document.createElement('td');
            let buttonDiv = document.createElement('div');
            buttonDiv.classList.add("row");
            buttonTd.appendChild(buttonDiv)


            let upButtonDiv = document.createElement('div');
            upButtonDiv.classList.add("column");
            buttonDiv.appendChild(upButtonDiv);

            let upButton = document.createElement('button');
            upButton.classList.add("table");
            upButton.classList.add("up");
            upButton.innerHTML = "·ê±";
            upButtonDiv.appendChild(upButton);


            let downButtonDiv = document.createElement('div');
            downButtonDiv.classList.add("column");
            buttonDiv.appendChild(downButtonDiv);

            let downButton = document.createElement('button');
            downButton.classList.add("table");
            downButton.classList.add("down");
            downButton.innerHTML = "·êØ";
            downButtonDiv.appendChild(downButton);


            let deleteButtonDiv = document.createElement('div');
            deleteButtonDiv.classList.add("column");
            buttonDiv.appendChild(deleteButtonDiv);

            let deleteButton = document.createElement('button');
            deleteButton.classList.add("table");
            deleteButton.classList.add("delete");
            deleteButton.innerHTML = 'üóë';
            deleteButton.addEventListener('click', () => deleteConnection(tr, ssid, pass));
            deleteButtonDiv.appendChild(deleteButton);

            tr.appendChild(buttonTd);
            return tr;
        }

        function getLedConf() {
            fetch("/conf/led.json")
                .then(async r => {
                    ledConf = await r.json();
                    renderLedConf();
                });
        }

        function renderLedConf() {
            document.getElementById("brightness").value = ledConf.brightness / 16;
            document.getElementById("mode").innerText = ledConf.mode + " / 16";
        }

        function updateLedConf() {
            fetch("/conf/led.json", {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ledConf)
            });
        }

        function clickButton(type) {
            if (type === '>' && ledConf.mode < 16) {
                ledConf.mode = ledConf.mode + 1;
            } else if (type === '<' && ledConf.mode > 0) {
                ledConf.mode = ledConf.mode - 1;
            } else return;
            updateLedConf();
            renderLedConf();
        }


        function changeBrightness(elem) {
            ledConf.brightness = elem.value * 16;
            updateLedConf();
            renderLedConf();
        }

        function updateInfo(tabName) {
            if (tabName === "settings") {
                fetch("/conf/wifi.json")
                    .then(async response => {
                        document.getElementById(tabName).style.display = "block";
                        if (response.ok) {
                            wifiConf = await response.json();
                            renderWifi();
                        }
                    });
            }
        }

        function renderWifi() {
            let apConfTable = document.getElementById("apConf");
            let apConf = apConfTable.getElementsByTagName("tr").item(1);
            apConf.getElementsByClassName("ssid").item(0).placeholder = wifiConf.ap.ssid;
            apConf.getElementsByClassName("password").item(0).placeholder = wifiConf.ap.pass;
            apConf.getElementsByClassName("active").item(0).checked = wifiConf.apOn;

            let coConfTable = document.getElementById("coConf");
            let foot = coConfTable.getElementsByTagName("tr").item(1);
            let tbody = coConfTable.getElementsByTagName("tbody").item(0);
            tbody.innerHTML = '';
            tbody.appendChild(foot);
            let conDoms = [];
            wifiConf.co.forEach(c => {
                let localConDom = createConnectionDom(c.ssid, c.pass);
                conDoms.push(localConDom);
            });
            conDoms.reverse().forEach(d =>
                foot.parentNode.insertBefore(d, foot)
            )

            let buttonElement = foot.getElementsByTagName("button").item(0);
            let ssidFoot = foot.getElementsByClassName("ssid").item(0);
            let passFoot = foot.getElementsByClassName("pass").item(0);
            buttonElement.addEventListener("click", () => {
                wifiConf.co.push({ssid: ssidFoot.value, pass: passFoot.value})
                foot.parentNode.insertBefore(createConnectionDom(ssidFoot.value, passFoot.value), foot);
            });
        }


        function deleteConnection(e, ssid, pass) {
            e.parentNode.removeChild(e);
            let toDeleteElem = undefined;
            for (let i = 0; i < wifiConf.co.length; i++) {
                const c = wifiConf.co[i];
                if (c.ssid === ssid && c.pass === pass) {
                    toDeleteElem = i;
                }
            }
            if (toDeleteElem != undefined) {
                wifiConf.co = wifiConf.co.splice(toDeleteElem, 1);
            }
            return false;
        }
    </script>
</head>
<body onload="initUpdForms(); getLedConf();">
<main class="wrapper">
    <nav class="navbar">
        <ul>
            <li>
                <a class="navigation-link" onclick="changeTab('control')">–ì–∏—Ä–ª—è–Ω–¥–∞</a>
            </li>
            <li>
                <a class="navigation-link" onclick="changeTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</a>
            </li>
            <li>
                <a class="navigation-link" onclick="changeTab('update')">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</a>
            </li>
        </ul>
    </nav>
    <section class="container" id="control">
        <br>
        <h2 style="text-align: center;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∏—Ä–ª—è–Ω–¥–æ–π</h2>
        <br>
        <h3>–Ø—Ä–∫–æ—Å—Ç—å :</h3>
        <div class="row">
            <input class="column" type="range" id="brightness" name="brightness" onchange="changeBrightness(this)"
                   min="0" max="16">
        </div>
        <br>
        <h3>–†–µ–∂–∏–º :</h3>
        <div class="row">
            <div class="column column-20">
                <button onclick="clickButton('<');" style="width: 100%"><h3><</h3></button>
            </div>
            <div class="column column-60">
                <h3 style="text-align: center;" id="mode"> -- / 16</h3>
            </div>
            <div class="column column-20">
                <button onclick="clickButton('>');" style="width: 100%"><h3>></h3></button>
            </div>
        </div>
        <br>
    </section>
    <section class="container" id="settings" style="display: none">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ WiFi</h2>
        <div>–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞. –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤</div>
        <table id='apConf'>
            <thead>
            <tr>
                <th>SSID</th>
                <th>password</th>
                <th>enabled</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><input class="table ssid" placeholder="loading"></td>
                <td><input class="table password" placeholder="loading"></td>
                <td>
                    <div class="row">
                        <div class='column'>
                            <input class="table active" type="checkbox">
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
        <table id='coConf'>
            <thead>
            <tr>
                <th>SSID</th>
                <th>password</th>
                <th>action</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><input class="table ssid"></td>
                <td><input class="table pass"></td>
                <td>
                    <div class="row">
                        <div class='column'>
                            <button class="table">add</button>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
        <button onclick="saveConfig()">save</button>
    </section>
    <section class="container" id="update" style="display: none">
        <fieldset id="code_fs">
            <h2>–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É</h2>
            <div class="row">
                <div class="column">
                    <label class="file" style="width: 100%">
                        <input id="code" type='file' name='file'>
                        <span class="file-custom"></span>
                    </label>
                </div>
                <div class="column column-10">
                    <button>Update</button>
                </div>
            </div>
        </fieldset>
        <fieldset id="fs_fs">
            <h2>–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã</h2>
            <div class="row" onload="initUpdForms(this)">
                <div class="column">
                    <label class="file" style="width: 100%">
                        <input id="fs" type='file' name='file'>
                        <span class="file-custom"></span>
                    </label>
                </div>
                <div class="column column-10">
                    <button>Update</button>
                </div>
            </div>
        </fieldset>
        <div>
            <h2>–õ–æ–≥</h2>
            <div id="log">
            </div>
        </div>
    </section>
</main>
</body>
</html>
